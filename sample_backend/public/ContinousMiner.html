<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Continuous Miner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0f1b2b;
    --panel:#17263c;
    --ink:#e6eef8;
    --muted:#a8b3c6;
    --track:#24364f;
    --ok:#1abc9c;
    --warn:#e67e22;
    --bad:#e74c3c;
    --blue:#3aa0ff;
    --purple:#9b59b6;
    --teal:#16a085;
    --yellow:#ffb300;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
  }
  header{
    padding:18px 22px;
    border-bottom:2px solid var(--yellow);
    font-weight:700;
    letter-spacing:.5px;
    display:flex;align-items:center;gap:12px;flex-wrap:wrap;
  }
  header .sub{color:var(--muted);font-weight:500}
  header .right{margin-left:auto;font-size:12px;color:var(--muted)}
  .wrap{padding:18px}
  .grid{
    display:grid; gap:18px;
    grid-template-columns: repeat(12,1fr);
  }
  .col-6{grid-column: span 6}
  .col-4{grid-column: span 4}
  .col-3{grid-column: span 3}
  .panel{
    background:var(--panel);
    border-radius:12px;
    padding:14px;
    box-shadow:0 0 0 1px #0b1626 inset, 0 6px 20px rgba(0,0,0,.25);
  }
  .panel h3{
    margin:0 0 12px;
    font-size:15px;
    letter-spacing:.4px;
    color:#fff;
  }

  /* metric rows */
  .metric-row{
    display:flex; gap:12px; align-items:center;
    background:#122136;
    border-radius:10px;
    padding:10px;
    margin-bottom:10px;
  }
  .metric-main{flex:1}
  .title{font-size:12px;color:var(--muted)}
  .value{font-size:20px;font-weight:700;margin-top:2px}
  .unit{opacity:.9;font-weight:600}
  .line{height:3px;background:var(--track);border-radius:3px;margin-top:6px;overflow:hidden}
  .line > span{display:block;height:100%;width:0}

  /* colored lines */
  .c-green .line > span{background:var(--ok)}
  .c-orange .line > span{background:var(--warn)}
  .c-red .line > span{background:var(--bad)}
  .c-blue .line > span{background:var(--blue)}
  .c-purple .line > span{background:var(--purple)}
  .c-teal .line > span{background:var(--teal)}
  .c-yellow .line > span{background:var(--yellow)}

  /* status pills */
  .pill{
    display:inline-block;
    padding:3px 8px;
    font-size:12px;
    font-weight:700;
    border-radius:16px;
    margin-top:6px;
  }
  .pill.ok{background:rgba(26,188,156,.18); color:var(--ok); box-shadow:0 0 0 1px rgba(26,188,156,.25) inset}
  .pill.warn{background:rgba(230,126,34,.18); color:var(--warn); box-shadow:0 0 0 1px rgba(230,126,34,.25) inset}
  .pill.bad{background:rgba(231,76,60,.18); color:var(--bad); box-shadow:0 0 0 1px rgba(231,76,60,.25) inset}

  /* donut with icon in center */
  .donut{
    --size:60px; --thick:9px; --p:0; --col:var(--ok);
    width:var(--size); height:var(--size); border-radius:50%;
    background: conic-gradient(var(--col) calc(var(--p) * 1%), var(--track) 0);
    position:relative; display:grid; place-items:center;
  }
  .donut::after{
    content:""; position:absolute; inset:calc(var(--thick) + 2px);
    background:var(--panel); border-radius:50%;
  }
  .donut .icon{
    position:relative; width:26px; height:26px; opacity:.95;
    fill:var(--ink);
  }

  .muted{color:var(--muted)}
  .small{font-size:12px}
  .detail-box{
    background:#0f1e31;border-radius:8px;padding:10px;font-size:12px;color:#cfe0f7;
    border:1px solid #0c1728;white-space:pre-wrap
  }

  .chart-wrap{
    background:#0f1e31;
    border:1px solid #0c1728;
    border-radius:10px;
    padding:10px;
    height:220px;
    display:flex; flex-direction:column;
  }
  .chart-head{
    display:flex; justify-content:space-between; align-items:baseline;
    margin-bottom:6px;
  }
  .chart-head .t{font-size:12px; color:var(--muted)}
  .chart-head .v{font-size:18px; font-weight:700}
  canvas#vibrationChart{width:100%; height:160px; display:block;}

  /* --- Mobile view only --- */
  @media (max-width:768px){
    .grid{grid-template-columns: 1fr !important; gap:12px;}
    .col-6,.col-4,.col-3{grid-column: span 1 !important;}
    header{flex-direction:column; align-items:flex-start; gap:4px; padding:12px 14px;}
    .wrap{padding:10px;}
    .panel{padding:10px; border-radius:8px;}
    .panel h3{font-size:14px; margin-bottom:8px;}
    .metric-row{padding:8px; gap:8px;}
    .value{font-size:16px;}
    .title{font-size:11px;}
    .donut{--size:48px; --thick:8px;}
    .donut .icon{width:20px; height:20px;}
    .chart-wrap{height:180px; padding:8px;}
    canvas#vibrationChart{height:120px;}
  }
</style>
</head>
<body>
<header>
  <div>CONTINUOUS MINER</div>
  <div class="sub">Power, Cutter, Hydraulics, PLC</div>
  <div class="right" id="lastUpdated">—</div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="panel col-6" id="panel-power">
      <h3>Power &amp; Electrical Systems</h3>
    </section>
    <section class="panel col-6" id="panel-cutter">
      <h3>Cutter &amp; Drum Systems</h3>
    </section>
    <section class="panel col-4" id="panel-hydraulic"><h3>Hydraulic Systems</h3></section>
    <section class="panel col-4" id="panel-safety"><h3>Safety &amp; Predictive Maintenance</h3></section>
    <section class="panel col-4" id="panel-plc"><h3>PLC &amp; Control Panels</h3></section>
  </div>
</div>

<script>
  // ---- Config ----
  const DEFAULT_COMPANY = new URLSearchParams(location.search).get('company') || 'velastra';
  const DEFAULT_SECTOR  = new URLSearchParams(location.search).get('sector')  || 'mining';
  // Use your backend URL (full absolute to avoid relative path issues in some setups)
  //const API_URL = `http://10.5.48.30:5001/fetch-continuous-data?company=${encodeURIComponent(DEFAULT_COMPANY)}&sector=${encodeURIComponent(DEFAULT_SECTOR)}`;

  // ---- Helpers ----
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const fmt   = (n,dec=0)=> (n==null || isNaN(n)) ? '-' : Number(n).toFixed(dec);
  const statusClass = (txt='')=>{
    const v=(txt||'').toString().toLowerCase();
    if (v.includes('fault') || v.includes('fail') || v.includes('hife')) return 'bad';
    if (v.includes('warn') || v.includes('alert') ) return 'warn';
    return 'ok';
  };

  function lineRow({title, value, unit='', percent=0, colorClass='c-green'}) {
    return `
      <div class="metric-row ${colorClass}">
        <div class="metric-main">
          <div class="title">${title}</div>
          <div class="value">${fmt(value, (unit==='psi'||unit==='kW'||unit==='h'||unit==='°F'||unit==='V') ? 0 : 0)} <span class="unit">${unit}</span></div>
          <div class="line"><span style="width:${clamp(percent,0,100)}%"></span></div>
        </div>
      </div>
    `;
  }

  function batteryRow({title, value, percent, color='#1abc9c', colorClass='c-green'}) {
    return `
      <div class="metric-row ${colorClass}">
        <div class="donut" style="--p:${clamp(percent,0,100)}; --col:${color}">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M2 8a2 2 0 0 1 2-2h13a2 2 0 0 1 2 2v1h1.2a.8.8 0 0 1 .8.8v4.4a.8.8 0 0 1-.8.8H19v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8zm3 1v6h10V9H5z"/>
          </svg>
        </div>
        <div class="metric-main">
          <div class="title">${title}</div>
          <div class="value">${fmt(value,0)}<span class="unit">%</span></div>
          <div class="line"><span style="width:${clamp(percent,0,100)}%"></span></div>
        </div>
      </div>
    `;
  }

  function pillRow(title, text){
    const cls = statusClass(text);
    return `
      <div class="metric-row">
        <div class="metric-main">
          <div class="title">${title}</div>
          <div class="pill ${cls}">${text ?? '-'}</div>
        </div>
      </div>
    `;
  }

  function detailsBox(title, text){
    return `
      <div class="metric-row">
        <div class="metric-main">
          <div class="title">${title}</div>
          <div class="detail-box">${(text && String(text).trim()) ? String(text) : '—'}</div>
        </div>
      </div>
    `;
  }

  // ---------- Tiny Canvas Line Chart (no external libraries) ----------
  function drawVibrationChart(canvas, points, labels){
    if (!canvas) return;

    // device pixel ratio handling
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const cssW = canvas.clientWidth || 300;
    const cssH = canvas.clientHeight || 160;
    canvas.width = Math.max(1, Math.floor(cssW * dpr));
    canvas.height = Math.max(1, Math.floor(cssH * dpr));

    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // scale for crisp drawing on HiDPI
    ctx.clearRect(0,0,cssW,cssH);

    // padding (more bottom room for time labels)
    const pad = {t:10, r:8, b:28, l:32};
    const W = cssW - pad.l - pad.r;
    const H = cssH - pad.t - pad.b;

    // guard
    if (!points || points.length < 2 || W<=0 || H<=0){
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#a8b3c6';
      ctx.font = '12px system-ui';
      ctx.fillText('Not enough data for chart', 10, 16);
      return;
    }

    // y scale
    const min = Math.min(...points);
    const max = Math.max(...points);
    const range = (max - min) || 1;
    const yMin = Math.floor(min - range*0.1);
    const yMax = Math.ceil(max + range*0.1);

    // colors
    const axis = getComputedStyle(document.documentElement).getPropertyValue('--track') || '#24364f';
    const lineCol = getComputedStyle(document.documentElement).getPropertyValue('--ok') || '#1abc9c';
    const gridCol = 'rgba(255,255,255,0.06)';
    const textCol = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#a8b3c6';

    // horizontal grid (3 lines)
    ctx.strokeStyle = gridCol;
    ctx.lineWidth = 1;
    for (let i=0;i<=3;i++){
      const y = pad.t + (H*(i/3));
      ctx.beginPath();
      ctx.moveTo(pad.l, y);
      ctx.lineTo(pad.l + W, y);
      ctx.stroke();
    }

    // axes
    ctx.strokeStyle = axis;
    ctx.beginPath();
    ctx.moveTo(pad.l, pad.t);
    ctx.lineTo(pad.l, pad.t + H);
    ctx.lineTo(pad.l + W, pad.t + H);
    ctx.stroke();

    // y labels (top and bottom)
    ctx.fillStyle = textCol;
    ctx.font = '11px system-ui';
    ctx.textAlign = 'right';
    ctx.fillText(yMax.toString(), pad.l - 6, pad.t + 10);
    ctx.fillText(yMin.toString(), pad.l - 6, pad.t + H);

    // x-axis ticks & labels — show up to 5 evenly spaced time labels in mm:ss
    const nTicks = Math.min(5, labels.length);
    ctx.textAlign = 'center';
    ctx.font = '11px system-ui';
    ctx.fillStyle = textCol;

    for (let i=0; i<nTicks; i++){
      const idx = Math.round(i * (labels.length - 1) / (nTicks - 1 || 1));
      const x = pad.l + (W * (idx/(labels.length-1)));
      const yAxis = pad.t + H;

      // small tick
      ctx.strokeStyle = axis;
      ctx.beginPath();
      ctx.moveTo(x, yAxis);
      ctx.lineTo(x, yAxis + 4);
      ctx.stroke();

      const lab = labels[idx] || '';
      ctx.fillText(lab, x, yAxis + 16);
    }

    // draw line
    ctx.strokeStyle = lineCol;
    ctx.lineWidth = 2;
    ctx.beginPath();
    points.forEach((v,i)=>{
      const x = pad.l + (W * (i/(points.length-1)));
      const y = pad.t + H - ((v - yMin) / (yMax - yMin)) * H;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // dots
    ctx.fillStyle = lineCol;
    points.forEach((v,i)=>{
      const x = pad.l + (W * (i/(points.length-1)));
      const y = pad.t + H - ((v - yMin) / (yMax - yMin)) * H;
      ctx.beginPath(); ctx.arc(x,y,2.8,0,Math.PI*2); ctx.fill();
    });
  }

  // ---- Render Panels ----
  function renderAll(latest, history){
    const pct = {
      battery : clamp(latest.battery_health ?? 0, 0, 100),
      voltage : clamp((latest.voltage ?? 0)/400*100, 0, 100),
      tMotor  : clamp((latest.traction_motor_temp ?? 0)/200*100, 0, 100),
      pick    : clamp((latest.pick_wear_monitoring ?? 0), 0, 100),
      cutterH : clamp((latest.cutter_hours ?? 0)/4000*100, 0, 100),
      torque  : clamp((latest.cutter_motor_torque_kw ?? 0)/500*100, 0, 100),
      faults  : clamp((latest.plc_fault_count ?? 0)/10*100, 0, 100),
      vib     : clamp((latest.vibration_level ?? 0)/100*100, 0, 100),
      hydP    : clamp((latest.hydraulic_pressure_psi ?? 0)/5000*100, 0, 100),
      hydT    : clamp((latest.hydraulic_oil_temp ?? 0)/200*100, 0, 100),
    };

    // --- POWER & ELECTRICAL ---
    const power = document.getElementById('panel-power');
    power.innerHTML = `
      <h3>Power &amp; Electrical Systems</h3>
      ${batteryRow({ title:'Battery Health', value: latest.battery_health, percent: pct.battery, color:'#1abc9c', colorClass:'c-green' })}
      ${lineRow({ title:'Voltage', value: latest.voltage, unit:'V', percent: pct.voltage, colorClass:'c-blue' })}
      ${lineRow({ title:'Traction Motor Temp', value: latest.traction_motor_temp, unit:'°F', percent: pct.tMotor, colorClass:'c-orange' })}
      ${lineRow({ title:'Pick Wear Monitoring', value: latest.pick_wear_monitoring, unit:'%', percent: pct.pick, colorClass:'c-yellow' })}
    `;

    // --- CUTTER & DRUM ---
    const cutter = document.getElementById('panel-cutter');
    cutter.innerHTML = `
      <h3>Cutter &amp; Drum Systems</h3>
      ${lineRow({ title:'Cutter Hours', value: latest.cutter_hours, unit:'h', percent: pct.cutterH, colorClass:'c-purple' })}
      ${pillRow('PLC Control Panels', latest.plc_control_panel_status ?? '-') }
      ${lineRow({ title:'Torque on Cutter Motor', value: latest.cutter_motor_torque_kw, unit:'kW', percent: pct.torque, colorClass:'c-teal' })}
      ${lineRow({ title:'PLC Faults', value: latest.plc_fault_count, unit:'alerts', percent: pct.faults, colorClass: (latest.plc_fault_count>0?'c-red':'c-green') })}
    `;

    // --- HYDRAULIC ---
    const hyd = document.getElementById('panel-hydraulic');
    hyd.innerHTML = `
      <h3>Hydraulic Systems</h3>
      ${lineRow({ title:'Hydraulic Pressure', value: latest.hydraulic_pressure_psi, unit:'psi', percent: pct.hydP, colorClass:'c-blue' })}
      ${pillRow('Hydraulic Oil Level', latest.hydraulic_oil_level ?? '-') }
      ${lineRow({ title:'Hydraulic Oil Temp', value: latest.hydraulic_oil_temp, unit:'°F', percent: pct.hydT, colorClass:'c-orange' })}
      ${pillRow('Hydraulic System Status', latest.hydraulic_system_status ?? '-') }
    `;

    // --- SAFETY / PREDICTIVE (CHART) ---
    const saf = document.getElementById('panel-safety');
    const latestV = latest.vibration_level ?? 0;

    // Build chart container (keeps layout as screenshot pattern)
    saf.innerHTML = `
      <h3>Safety &amp; Predictive Maintenance</h3>
      <div class="chart-wrap">
        <div class="chart-head">
          <div class="t">Vibration (last 10 readings)</div>
          <div class="v">${fmt(latestV,0)}</div>
        </div>
        <canvas id="vibrationChart" aria-label="Vibration history line chart"></canvas>
      </div>
    `;

    // Prepare last 10 points (ascending by time)
    const sorted = [...history].sort((a,b)=> new Date(a.log_timestamp) - new Date(b.log_timestamp));
    const last10 = sorted.slice(-10);
    const points = last10.map(d => Number(d.vibration_level ?? 0));

    // Labels in MM:SS (like 32:00, 35:00, 38:00)
    const labels = last10.map(d => {
      const dt = new Date(d.log_timestamp);
      if (isNaN(dt)) return '';
      const mm = String(dt.getMinutes()).padStart(2,'0');
      const ss = String(dt.getSeconds()).padStart(2,'0');
      return `${mm}:${ss}`;
    });

    // Draw chart
    const canvas = document.getElementById('vibrationChart');
    drawVibrationChart(canvas, points, labels);

    // --- PLC / CONTROL ---
    const plc = document.getElementById('panel-plc');
    plc.innerHTML = `
      <h3>PLC &amp; Control Panels</h3>
      ${pillRow('Traction Control', latest.traction_control_status ?? '-') }
      ${pillRow('Cutter Control', latest.cutter_control_status ?? '-') }
      ${detailsBox('PLC Fault Details', latest.plc_fault_details ?? '')}
    `;
  }

  // ---- Fetch & Update ----
  async function loadData(){
    try{
      const r = await fetch(API_URL, {cache:'no-store'});
      const j = await r.json();
      // API expected format: { status: "success", company: "...", sector:"...", data: [ {...}, {...}, ... ] }
      if (!j || j.status !== 'success' || !Array.isArray(j.data) || j.data.length===0){
        document.getElementById('lastUpdated').textContent = 'No data';
        return;
      }
      // data from backend seems returned newest-first (DESC); keep that but create history ascending for chart
      const latest = j.data[0];
      const history = j.data;

      renderAll(latest, history);

      const ts = latest.log_timestamp ? new Date(latest.log_timestamp) : new Date();
      document.getElementById('lastUpdated').textContent =
        `Company: ${j.company} • Sector: ${j.sector} • Updated: ${ts.toLocaleString()}`;
    }catch(err){
      document.getElementById('lastUpdated').textContent = 'Error loading data';
      console.error(err);
    }
  }

  // initial + auto refresh every 3 minutes
  loadData();
  setInterval(loadData, 180000);

  // redraw chart on resize (keeps it crisp)
  window.addEventListener('resize', () => {
    const c = document.getElementById('vibrationChart');
    if (!c) return;
    // easiest: reload data (re-renders chart)
    loadData();
  });

</script>
</body>
</html>
